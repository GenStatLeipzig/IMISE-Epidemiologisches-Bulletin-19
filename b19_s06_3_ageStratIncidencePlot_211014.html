
<!DOCTYPE html>
<html>
<head>
<style type="text/css">
.inline {
  background-color: #f7f7f7;
  border:solid 1px #B0B0B0;
}
.error {
	font-weight: bold;
	color: #FF0000;
}
.warning {
	font-weight: bold;
}
.message {
	font-style: italic;
}
.source, .output, .warning, .error, .message {
	padding: 0 1em;
  border:solid 1px #F7F7F7;
}
.source {
  background-color: #f5f5f5;
}
.left {
  text-align: left;
}
.right {
  text-align: right;
}
.center {
  text-align: center;
}
.hl.num {
  color: #AF0F91;
}
.hl.str {
  color: #317ECC;
}
.hl.com {
  color: #AD95AF;
  font-style: italic;
}
.hl.opt {
  color: #000000;
}
.hl.std {
  color: #585858;
}
.hl.kwa {
  color: #295F94;
  font-weight: bold;
}
.hl.kwb {
  color: #B05A65;
}
.hl.kwc {
  color: #55aa55;
}
.hl.kwd {
  color: #BC5A65;
  font-weight: bold;
}
</style>
  <script src="https://yihui.name/media/js/center-images.js"></script>
  <title>A Report Generated by knitr</title>
</head>
<body>

  <p>This report is automatically generated with the R
    package <a href="https://yihui.name/knitr/"><strong>knitr</strong></a>
    (version <code class="knitr inline">1.36</code>)
    .</p>

<div class="chunk" id="auto-report"><div class="rcode"><div class="source"><pre class="knitr r"><span class="hl com"># Setup ----</span>
<span class="hl kwd">rm</span><span class="hl std">(</span><span class="hl kwc">list</span> <span class="hl std">=</span> <span class="hl kwd">ls</span><span class="hl std">())</span>
<span class="hl kwd">library</span><span class="hl std">(data.table)</span>
<span class="hl kwd">library</span><span class="hl std">(ggplot2)</span>
<span class="hl kwd">library</span><span class="hl std">(ggthemes)</span>
<span class="hl kwd">library</span><span class="hl std">(magrittr)</span>
<span class="hl kwd">library</span><span class="hl std">(scales)</span>
<span class="hl kwd">require</span><span class="hl std">(here)</span>
<span class="hl kwd">require</span><span class="hl std">(lubridate)</span>

<span class="hl com"># based on: https://github.com/holgerman/covid19_germanyByAge/blob/main/covid19_germanyByAge/app.R</span>

<span class="hl com"># Read data ----</span>

<span class="hl com"># read data of all age groups in germany and saxony</span>
<span class="hl std">dat_age_ger</span> <span class="hl kwb">&lt;-</span> <span class="hl kwd">fread</span><span class="hl std">(</span><span class="hl kwd">here</span><span class="hl std">(</span><span class="hl str">&quot;data/211014_population_germany.csv&quot;</span><span class="hl std">),</span> <span class="hl kwc">fill</span> <span class="hl std">=</span> <span class="hl num">TRUE</span><span class="hl std">,</span> <span class="hl kwc">encoding</span> <span class="hl std">=</span> <span class="hl str">&quot;UTF-8&quot;</span><span class="hl std">)</span>
<span class="hl std">dat_age_sax</span> <span class="hl kwb">&lt;-</span> <span class="hl kwd">fread</span><span class="hl std">(</span><span class="hl kwd">here</span><span class="hl std">(</span><span class="hl str">&quot;data/211014_population_saxony.csv&quot;</span><span class="hl std">),</span> <span class="hl kwc">fill</span> <span class="hl std">=</span> <span class="hl num">TRUE</span><span class="hl std">,</span> <span class="hl kwc">encoding</span> <span class="hl std">=</span> <span class="hl str">&quot;UTF-8&quot;</span><span class="hl std">)</span>

<span class="hl com"># read data of confirmed covid cases</span>
<span class="hl com"># dat_cases_age =  fread(here('data/b19_206_2_dat_cases_age.txt'), encoding = &quot;UTF-8&quot;) # &quot;https://raw.githubusercontent.com/KITmetricslab/covid19-forecast-hub-de/master/data-truth/RKI/by_age/truth_RKI-Incident%20Cases%20by%20Age_Germany.csv&quot;, encoding = &quot;UTF-8&quot;) from 16.10.21</span>

<span class="hl std">dat_cases_age</span> <span class="hl kwb">=</span>  <span class="hl kwd">fread</span><span class="hl std">(</span><span class="hl str">&quot;https://raw.githubusercontent.com/KITmetricslab/covid19-forecast-hub-de/master/data-truth/RKI/by_age/truth_RKI-Incident%20Cases%20by%20Age_Germany.csv&quot;</span><span class="hl std">,</span> <span class="hl kwc">encoding</span> <span class="hl std">=</span> <span class="hl str">&quot;UTF-8&quot;</span><span class="hl std">)</span>

<span class="hl com"># Clean data ----</span>


<span class="hl std">dat_cases_age[location_name</span> <span class="hl opt">==</span> <span class="hl str">&quot;Germany&quot;</span><span class="hl std">]</span>
</pre></div>
<div class="output"><pre class="knitr r">##             date location location_name age_group value
##    1: 2020-03-25       GM       Germany   A00-A04    32
##    2: 2020-03-25       GM       Germany   A05-A14    81
##    3: 2020-03-25       GM       Germany   A15-A34  1045
##    4: 2020-03-25       GM       Germany   A35-A59  1989
##    5: 2020-03-25       GM       Germany   A60-A79   754
##   ---                                                  
## 4140: 2021-11-07       GM       Germany   A15-A34  6684
## 4141: 2021-11-07       GM       Germany   A35-A59  8435
## 4142: 2021-11-07       GM       Germany   A60-A79  2954
## 4143: 2021-11-07       GM       Germany      A80+  1037
## 4144: 2021-11-07       GM       Germany unbekannt    15
</pre></div>
<div class="source"><pre class="knitr r"><span class="hl std">dat_cases_age[location_name</span> <span class="hl opt">==</span> <span class="hl str">&quot;Free State of Saxony&quot;</span><span class="hl std">]</span>
</pre></div>
<div class="output"><pre class="knitr r">##             date location        location_name age_group value
##    1: 2020-03-25     GM13 Free State of Saxony   A00-A04     0
##    2: 2020-03-25     GM13 Free State of Saxony   A05-A14     4
##    3: 2020-03-25     GM13 Free State of Saxony   A15-A34    33
##    4: 2020-03-25     GM13 Free State of Saxony   A35-A59    72
##    5: 2020-03-25     GM13 Free State of Saxony   A60-A79    30
##   ---                                                         
## 3775: 2021-11-07     GM13 Free State of Saxony   A15-A34   694
## 3776: 2021-11-07     GM13 Free State of Saxony   A35-A59   956
## 3777: 2021-11-07     GM13 Free State of Saxony   A60-A79   381
## 3778: 2021-11-07     GM13 Free State of Saxony      A80+   170
## 3779: 2021-11-07     GM13 Free State of Saxony unbekannt     0
</pre></div>
<div class="source"><pre class="knitr r"><span class="hl com"># I only need germany and saxony</span>
<span class="hl std">dat_cases_age</span> <span class="hl kwb">&lt;-</span> <span class="hl std">dat_cases_age[location_name</span> <span class="hl opt">%in%</span> <span class="hl kwd">c</span><span class="hl std">(</span><span class="hl str">&quot;Germany&quot;</span><span class="hl std">,</span> <span class="hl str">&quot;Free State of Saxony&quot;</span><span class="hl std">)]</span>


<span class="hl com"># add overall group----</span>
<span class="hl std">dat_cases_all</span> <span class="hl kwb">=</span> <span class="hl std">dat_cases_age[,</span> <span class="hl kwd">.</span><span class="hl std">(</span><span class="hl kwc">value</span> <span class="hl std">=</span> <span class="hl kwd">sum</span><span class="hl std">(value),</span> <span class="hl kwc">age_group</span><span class="hl std">=</span><span class="hl str">&quot;alle&quot;</span><span class="hl std">),</span> <span class="hl kwd">.</span><span class="hl std">(date, location, location_name)]</span>
<span class="hl std">toolboxH</span><span class="hl opt">::</span><span class="hl kwd">showNA</span><span class="hl std">(dat_cases_all)</span>
</pre></div>
<div class="output"><pre class="knitr r">##             var NAs vals
## 1          date   0 1184
## 2      location   0 1184
## 3 location_name   0 1184
## 4         value   0 1184
## 5     age_group   0 1184
## 6   ROWS_NO_NAs   0 1184
</pre></div>
<div class="source"><pre class="knitr r"><span class="hl std">dat_cases_age</span> <span class="hl kwb">=</span> <span class="hl kwd">unique</span><span class="hl std">(</span><span class="hl kwd">rbind</span><span class="hl std">(dat_cases_age, dat_cases_all))</span>

<span class="hl com"># exclude unknown age</span>
<span class="hl std">dat_cases_age</span> <span class="hl kwb">&lt;-</span> <span class="hl std">dat_cases_age[age_group</span> <span class="hl opt">!=</span> <span class="hl str">&quot;unbekannt&quot;</span><span class="hl std">]</span>
<span class="hl com"># check</span>
<span class="hl kwd">stopifnot</span><span class="hl std">(dat_cases_age[age_group</span><span class="hl opt">==</span><span class="hl str">&quot;unbekannt&quot;</span><span class="hl std">, .N</span> <span class="hl opt">==</span> <span class="hl num">0</span><span class="hl std">])</span>

<span class="hl com"># clean values &lt; 0</span>
<span class="hl com"># dat_cases_age[value &lt; 0, ][order(date)]</span>
<span class="hl com"># </span>
<span class="hl com"># dat_cases_age[value &gt;= 0, ] # TODO Negativ sollten Nachmeldungen sein, dass am vorigen Tag zu viel gemeldet wurde. Muessten eigentlich mit vorigem Tag verrechnet werden, i.e. vorigen Tag nach unten korrigieren. In schleife, fall dann voriger Tag negativ wird, bis keiner mehr negativ ist. Fuer aktuelle Darstellung im Bulletin 19 aber ausreichend </span>

<span class="hl com"># useless group</span>
<span class="hl std">dat_cases_age</span><span class="hl opt">$</span><span class="hl std">location</span> <span class="hl kwb">&lt;-</span> <span class="hl kwa">NULL</span>

<span class="hl com"># Create age groups ----</span>

<span class="hl com"># create age group totals</span>
<span class="hl std">all_groups</span> <span class="hl kwb">&lt;-</span> <span class="hl kwd">unique</span><span class="hl std">(dat_cases_age</span><span class="hl opt">$</span><span class="hl std">age_group)</span>

<span class="hl com"># for german total data</span>
<span class="hl std">dat_age_ger</span><span class="hl opt">$</span><span class="hl std">age_group</span> <span class="hl kwb">&lt;-</span> <span class="hl kwa">NULL</span>
</pre></div>
<div class="warning"><pre class="knitr r">## Warning in set(x, j = name, value = value): Column 'age_group' does not exist to remove
</pre></div>
<div class="source"><pre class="knitr r"><span class="hl std">dat_age_ger[</span><span class="hl num">1</span><span class="hl opt">:</span><span class="hl kwd">which</span><span class="hl std">(age</span> <span class="hl opt">==</span> <span class="hl str">&quot;4-Jährige&quot;</span><span class="hl std">), age_group</span> <span class="hl kwb">:=</span> <span class="hl std">all_groups[</span><span class="hl num">1</span><span class="hl std">]]</span>
<span class="hl std">dat_age_ger[</span><span class="hl kwd">which</span><span class="hl std">(age</span> <span class="hl opt">==</span> <span class="hl str">&quot;5-Jährige&quot;</span><span class="hl std">)</span><span class="hl opt">:</span><span class="hl kwd">which</span><span class="hl std">(age</span> <span class="hl opt">==</span> <span class="hl str">&quot;14-Jährige&quot;</span><span class="hl std">), age_group</span> <span class="hl kwb">:=</span> <span class="hl std">all_groups[</span><span class="hl num">2</span><span class="hl std">]]</span>
<span class="hl std">dat_age_ger[</span><span class="hl kwd">which</span><span class="hl std">(age</span> <span class="hl opt">==</span> <span class="hl str">&quot;15-Jährige&quot;</span><span class="hl std">)</span><span class="hl opt">:</span><span class="hl kwd">which</span><span class="hl std">(age</span> <span class="hl opt">==</span> <span class="hl str">&quot;34-Jährige&quot;</span><span class="hl std">), age_group</span> <span class="hl kwb">:=</span> <span class="hl std">all_groups[</span><span class="hl num">3</span><span class="hl std">]]</span>
<span class="hl std">dat_age_ger[</span><span class="hl kwd">which</span><span class="hl std">(age</span> <span class="hl opt">==</span> <span class="hl str">&quot;35-Jährige&quot;</span><span class="hl std">)</span><span class="hl opt">:</span><span class="hl kwd">which</span><span class="hl std">(age</span> <span class="hl opt">==</span> <span class="hl str">&quot;59-Jährige&quot;</span><span class="hl std">), age_group</span> <span class="hl kwb">:=</span> <span class="hl std">all_groups[</span><span class="hl num">4</span><span class="hl std">]]</span>
<span class="hl std">dat_age_ger[</span><span class="hl kwd">which</span><span class="hl std">(age</span> <span class="hl opt">==</span> <span class="hl str">&quot;60-Jährige&quot;</span><span class="hl std">)</span><span class="hl opt">:</span><span class="hl kwd">which</span><span class="hl std">(age</span> <span class="hl opt">==</span> <span class="hl str">&quot;79-Jährige&quot;</span><span class="hl std">), age_group</span> <span class="hl kwb">:=</span> <span class="hl std">all_groups[</span><span class="hl num">5</span><span class="hl std">]]</span>
<span class="hl std">dat_age_ger[</span><span class="hl kwd">which</span><span class="hl std">(age</span> <span class="hl opt">==</span> <span class="hl str">&quot;80-Jährige&quot;</span><span class="hl std">)</span><span class="hl opt">:</span><span class="hl std">.N, age_group</span> <span class="hl kwb">:=</span> <span class="hl std">all_groups[</span><span class="hl num">6</span><span class="hl std">]]</span>

<span class="hl com"># for saxony data</span>
<span class="hl std">dat_age_sax</span><span class="hl opt">$</span><span class="hl std">age_group</span> <span class="hl kwb">&lt;-</span> <span class="hl kwa">NULL</span>
</pre></div>
<div class="warning"><pre class="knitr r">## Warning in set(x, j = name, value = value): Column 'age_group' does not exist to remove
</pre></div>
<div class="source"><pre class="knitr r"><span class="hl std">dat_age_sax[</span><span class="hl num">1</span><span class="hl opt">:</span><span class="hl kwd">which</span><span class="hl std">(age</span> <span class="hl opt">==</span> <span class="hl str">&quot;4-Jährige&quot;</span><span class="hl std">), age_group</span> <span class="hl kwb">:=</span> <span class="hl std">all_groups[</span><span class="hl num">1</span><span class="hl std">]]</span>
<span class="hl std">dat_age_sax[</span><span class="hl kwd">which</span><span class="hl std">(age</span> <span class="hl opt">==</span> <span class="hl str">&quot;5-Jährige&quot;</span><span class="hl std">)</span><span class="hl opt">:</span><span class="hl kwd">which</span><span class="hl std">(age</span> <span class="hl opt">==</span> <span class="hl str">&quot;14-Jährige&quot;</span><span class="hl std">), age_group</span> <span class="hl kwb">:=</span> <span class="hl std">all_groups[</span><span class="hl num">2</span><span class="hl std">]]</span>
<span class="hl std">dat_age_sax[</span><span class="hl kwd">which</span><span class="hl std">(age</span> <span class="hl opt">==</span> <span class="hl str">&quot;15-Jährige&quot;</span><span class="hl std">)</span><span class="hl opt">:</span><span class="hl kwd">which</span><span class="hl std">(age</span> <span class="hl opt">==</span> <span class="hl str">&quot;34-Jährige&quot;</span><span class="hl std">), age_group</span> <span class="hl kwb">:=</span> <span class="hl std">all_groups[</span><span class="hl num">3</span><span class="hl std">]]</span>
<span class="hl std">dat_age_sax[</span><span class="hl kwd">which</span><span class="hl std">(age</span> <span class="hl opt">==</span> <span class="hl str">&quot;35-Jährige&quot;</span><span class="hl std">)</span><span class="hl opt">:</span><span class="hl kwd">which</span><span class="hl std">(age</span> <span class="hl opt">==</span> <span class="hl str">&quot;59-Jährige&quot;</span><span class="hl std">), age_group</span> <span class="hl kwb">:=</span> <span class="hl std">all_groups[</span><span class="hl num">4</span><span class="hl std">]]</span>
<span class="hl std">dat_age_sax[</span><span class="hl kwd">which</span><span class="hl std">(age</span> <span class="hl opt">==</span> <span class="hl str">&quot;60-Jährige&quot;</span><span class="hl std">)</span><span class="hl opt">:</span><span class="hl kwd">which</span><span class="hl std">(age</span> <span class="hl opt">==</span> <span class="hl str">&quot;79-Jährige&quot;</span><span class="hl std">), age_group</span> <span class="hl kwb">:=</span> <span class="hl std">all_groups[</span><span class="hl num">5</span><span class="hl std">]]</span>
<span class="hl std">dat_age_sax[</span><span class="hl kwd">which</span><span class="hl std">(age</span> <span class="hl opt">==</span> <span class="hl str">&quot;80-Jährige&quot;</span><span class="hl std">)</span><span class="hl opt">:</span><span class="hl std">.N, age_group</span> <span class="hl kwb">:=</span> <span class="hl std">all_groups[</span><span class="hl num">6</span><span class="hl std">]]</span>

<span class="hl com"># summarize by age group</span>
<span class="hl std">dat_age_ger_sum</span> <span class="hl kwb">&lt;-</span> <span class="hl std">dat_age_ger[,</span> <span class="hl kwd">.</span><span class="hl std">(</span><span class="hl kwc">pop_sum</span> <span class="hl std">=</span> <span class="hl kwd">sum</span><span class="hl std">(pop_total)),</span> <span class="hl kwc">by</span> <span class="hl std">= age_group]</span>
<span class="hl std">dat_age_ger_sum[, location_name</span> <span class="hl kwb">:=</span> <span class="hl str">&quot;Germany&quot;</span><span class="hl std">]</span>
<span class="hl std">dat_age_sax_sum</span> <span class="hl kwb">&lt;-</span> <span class="hl std">dat_age_sax[,</span> <span class="hl kwd">.</span><span class="hl std">(</span><span class="hl kwc">pop_sum</span> <span class="hl std">=</span> <span class="hl kwd">sum</span><span class="hl std">(pop_sac)),</span> <span class="hl kwc">by</span> <span class="hl std">= age_group]</span>
<span class="hl std">dat_age_sax_sum[, location_name</span> <span class="hl kwb">:=</span> <span class="hl str">&quot;Free State of Saxony&quot;</span><span class="hl std">]</span>

<span class="hl com"># merge</span>
<span class="hl std">dat_age_sum_pre</span> <span class="hl kwb">&lt;-</span> <span class="hl kwd">rbindlist</span><span class="hl std">(</span><span class="hl kwd">list</span><span class="hl std">(dat_age_ger_sum, dat_age_sax_sum))</span>
<span class="hl std">dat_age_sum_all</span> <span class="hl kwb">=</span> <span class="hl std">dat_age_sum_pre[,</span><span class="hl kwd">.</span><span class="hl std">(</span><span class="hl kwc">age_group</span> <span class="hl std">=</span> <span class="hl str">&quot;alle&quot;</span><span class="hl std">,</span><span class="hl kwc">pop_sum</span> <span class="hl std">=</span> <span class="hl kwd">sum</span><span class="hl std">(pop_sum)),</span> <span class="hl kwd">.</span><span class="hl std">(location_name)]</span>
<span class="hl std">dat_age_sum</span> <span class="hl kwb">=</span> <span class="hl kwd">rbind</span><span class="hl std">(dat_age_sum_pre, dat_age_sum_all)</span>
<span class="hl std">dat_age_sum</span>
</pre></div>
<div class="output"><pre class="knitr r">##     age_group  pop_sum        location_name
##  1:   A00-A04  3969138              Germany
##  2:   A05-A14  7508662              Germany
##  3:   A15-A34 18921292              Germany
##  4:   A35-A59 28666166              Germany
##  5:   A60-A79 18153339              Germany
##  6:      A80+  5936434              Germany
##  7:   A00-A04   180370 Free State of Saxony
##  8:   A05-A14   365417 Free State of Saxony
##  9:   A15-A34   786243 Free State of Saxony
## 10:   A35-A59  1351804 Free State of Saxony
## 11:   A60-A79  1011120 Free State of Saxony
## 12:      A80+   361987 Free State of Saxony
## 13:      alle 83155031              Germany
## 14:      alle  4056941 Free State of Saxony
</pre></div>
<div class="source"><pre class="knitr r"><span class="hl com"># Merge data ----</span>

<span class="hl com"># match to dat_cases_age</span>
<span class="hl std">m1</span> <span class="hl kwb">&lt;-</span> <span class="hl kwd">match</span><span class="hl std">(</span>
  <span class="hl std">dat_cases_age[,</span> <span class="hl kwd">paste0</span><span class="hl std">(location_name, age_group)],</span>
  <span class="hl std">dat_age_sum[,</span> <span class="hl kwd">paste0</span><span class="hl std">(location_name, age_group)]</span>
<span class="hl std">)</span>
<span class="hl std">dat_cases_age[, pop_group</span> <span class="hl kwb">:=</span> <span class="hl std">dat_age_sum[m1, pop_sum]]</span>

<span class="hl com"># Calculate incidence and rolling sum ----</span>


<span class="hl com"># get incidence PER age group</span>
<span class="hl std">dat_cases_age[, value_per_group</span> <span class="hl kwb">:=</span> <span class="hl std">(value</span> <span class="hl opt">/</span> <span class="hl std">pop_group)</span> <span class="hl opt">*</span> <span class="hl num">100000</span><span class="hl std">]</span>


<span class="hl com"># numeric error?</span>
<span class="hl com"># dat_cases_age[,  .((value / (pop_group / 100000)),((value / pop_group)* 100000))][V1 != V2, plot(V1~V2)]</span>

<span class="hl com"># get the rolling mean over 7 days?</span>
<span class="hl com"># dat_cases_age[,  val_mean := frollmean(n = 7, x = value_per_group, align = &quot;right&quot;, na.rm = T), .(location_name, age_group)]</span>

<span class="hl com"># for each age group</span>
<span class="hl kwd">setorder</span><span class="hl std">(dat_cases_age, date, location_name, age_group)</span>
<span class="hl std">dat_cases_age[,  val_sum_group</span> <span class="hl kwb">:=</span> <span class="hl kwd">frollsum</span><span class="hl std">(</span>
  <span class="hl kwc">n</span> <span class="hl std">=</span> <span class="hl num">7</span><span class="hl std">,</span>
  <span class="hl kwc">x</span> <span class="hl std">= value_per_group,</span>
  <span class="hl kwc">align</span> <span class="hl std">=</span> <span class="hl str">&quot;right&quot;</span><span class="hl std">,</span>
  <span class="hl kwc">na.rm</span> <span class="hl std">= T),</span> <span class="hl kwd">.</span><span class="hl std">(location_name, age_group)]</span>



<span class="hl com"># Plotting ----</span>

<span class="hl com"># plot with 100k per age group</span>
<span class="hl std">brk_vec</span> <span class="hl kwb">=</span> <span class="hl kwd">seq</span><span class="hl std">(</span><span class="hl kwd">max</span><span class="hl std">(dat_cases_age</span><span class="hl opt">$</span><span class="hl std">date),</span><span class="hl kwd">min</span><span class="hl std">(dat_cases_age</span><span class="hl opt">$</span><span class="hl std">date),</span> <span class="hl opt">-</span><span class="hl num">14</span><span class="hl std">)</span>

<span class="hl std">dat_cases_age[, location_name</span> <span class="hl kwb">:=</span> <span class="hl kwd">factor</span><span class="hl std">(location_name,</span> <span class="hl kwc">levels</span> <span class="hl std">=</span> <span class="hl kwd">c</span><span class="hl std">(</span><span class="hl str">&quot;Germany&quot;</span><span class="hl std">,</span> <span class="hl str">&quot;Free State of Saxony&quot;</span><span class="hl std">))]</span>

<span class="hl std">mindat</span> <span class="hl kwb">=</span> <span class="hl kwd">as_date</span><span class="hl std">(</span><span class="hl str">&quot;2021-06-07&quot;</span><span class="hl std">)</span>
<span class="hl std">p1</span> <span class="hl kwb">&lt;-</span> <span class="hl kwd">ggplot</span><span class="hl std">(dat_cases_age[age_group</span><span class="hl opt">!=</span><span class="hl str">&quot;alle&quot;</span> <span class="hl opt">&amp;</span> <span class="hl std">date</span> <span class="hl opt">&gt;=</span> <span class="hl std">mindat, ],</span>
             <span class="hl kwd">aes</span><span class="hl std">(date,</span>
                 <span class="hl std">val_sum_group,</span>
                 <span class="hl kwc">color</span> <span class="hl std">= age_group )</span>
<span class="hl std">)</span> <span class="hl opt">+</span>
  <span class="hl kwd">geom_line</span><span class="hl std">(</span><span class="hl kwc">size</span> <span class="hl std">=</span> <span class="hl num">2</span><span class="hl std">,</span> <span class="hl kwc">alpha</span><span class="hl std">=</span> <span class="hl num">0.5</span><span class="hl std">)</span> <span class="hl opt">+</span>
  <span class="hl kwd">geom_line</span><span class="hl std">(</span><span class="hl kwc">data</span> <span class="hl std">= dat_cases_age[age_group</span><span class="hl opt">==</span><span class="hl str">&quot;alle&quot;</span> <span class="hl opt">&amp;</span> <span class="hl std">date</span> <span class="hl opt">&gt;=</span> <span class="hl std">mindat],</span> <span class="hl kwc">color</span> <span class="hl std">=</span> <span class="hl str">&quot;black&quot;</span><span class="hl std">,</span> <span class="hl kwc">size</span> <span class="hl std">=</span> <span class="hl num">1.5</span><span class="hl std">,</span><span class="hl kwc">lty</span> <span class="hl std">=</span> <span class="hl num">3</span><span class="hl std">,</span> <span class="hl kwc">alpha</span><span class="hl std">=</span> <span class="hl num">0.7</span><span class="hl std">)</span> <span class="hl opt">+</span>
  <span class="hl kwd">geom_line</span><span class="hl std">(</span><span class="hl kwc">data</span> <span class="hl std">= dat_cases_age[age_group</span><span class="hl opt">==</span><span class="hl str">&quot;alle&quot;</span> <span class="hl opt">&amp;</span> <span class="hl std">date</span> <span class="hl opt">&gt;=</span> <span class="hl std">mindat],</span> <span class="hl kwc">color</span> <span class="hl std">=</span> <span class="hl str">&quot;black&quot;</span><span class="hl std">,</span> <span class="hl kwc">size</span> <span class="hl std">=</span> <span class="hl num">1.5</span><span class="hl std">,</span><span class="hl kwc">lty</span> <span class="hl std">=</span> <span class="hl num">1</span><span class="hl std">,</span> <span class="hl kwc">alpha</span><span class="hl std">=</span> <span class="hl num">0.5</span><span class="hl std">)</span> <span class="hl opt">+</span>
  <span class="hl kwd">facet_wrap</span><span class="hl std">(</span><span class="hl opt">~</span><span class="hl std">location_name,</span>
             <span class="hl kwc">scales</span> <span class="hl std">=</span> <span class="hl str">&quot;fixed&quot;</span><span class="hl std">,</span>
             <span class="hl kwc">labeller</span> <span class="hl std">=</span> <span class="hl kwd">labeller</span><span class="hl std">(</span>
               <span class="hl kwc">location_name</span> <span class="hl std">=</span> <span class="hl kwd">c</span><span class="hl std">(</span>
                 <span class="hl str">&quot;Germany&quot;</span> <span class="hl std">=</span> <span class="hl str">&quot;Deutschland&quot;</span><span class="hl std">,</span>
                 <span class="hl str">&quot;Free State of Saxony&quot;</span> <span class="hl std">=</span> <span class="hl str">&quot;Freistaat Sachsen&quot;</span>
               <span class="hl std">)))</span> <span class="hl opt">+</span>
  <span class="hl kwd">scale_y_log10</span><span class="hl std">(</span>
    <span class="hl kwc">breaks</span> <span class="hl std">=</span> <span class="hl kwd">log_breaks</span><span class="hl std">(</span><span class="hl num">14</span><span class="hl std">),</span>
    <span class="hl kwc">label</span> <span class="hl std">=</span> <span class="hl kwd">label_comma</span><span class="hl std">(</span><span class="hl kwc">accuracy</span> <span class="hl std">=</span> <span class="hl num">1</span><span class="hl std">),</span>
    <span class="hl kwc">sec.axis</span> <span class="hl std">=</span><span class="hl kwd">dup_axis</span><span class="hl std">()</span>

  <span class="hl std">)</span> <span class="hl opt">+</span>
  <span class="hl kwd">theme_pander</span><span class="hl std">(</span><span class="hl kwc">base_size</span> <span class="hl std">=</span> <span class="hl num">14</span><span class="hl std">)</span> <span class="hl opt">+</span>
  <span class="hl kwd">theme</span><span class="hl std">(</span><span class="hl kwc">axis.text.x</span> <span class="hl std">=</span> <span class="hl kwd">element_text</span><span class="hl std">(</span><span class="hl kwc">angle</span> <span class="hl std">=</span> <span class="hl num">90</span><span class="hl std">,</span> <span class="hl kwc">vjust</span> <span class="hl std">=</span> <span class="hl num">0.4</span><span class="hl std">),</span>
        <span class="hl kwc">panel.grid.major</span> <span class="hl std">=</span> <span class="hl kwd">element_line</span><span class="hl std">(</span><span class="hl kwc">linetype</span> <span class="hl std">=</span> <span class="hl str">&quot;solid&quot;</span><span class="hl std">),</span>
        <span class="hl kwc">panel.grid.minor</span> <span class="hl std">=</span> <span class="hl kwd">element_blank</span><span class="hl std">(),</span>
        <span class="hl kwc">legend.position</span> <span class="hl std">=</span> <span class="hl str">&quot;bottom&quot;</span>
  <span class="hl std">)</span> <span class="hl opt">+</span>
  <span class="hl kwd">scale_x_date</span><span class="hl std">(</span><span class="hl kwc">breaks</span> <span class="hl std">= brk_vec,</span> <span class="hl kwc">date_labels</span> <span class="hl std">=</span> <span class="hl str">&quot;%d-%b-%y&quot;</span>   <span class="hl std">)</span> <span class="hl opt">+</span>
  <span class="hl kwd">ylab</span><span class="hl std">(</span><span class="hl str">&quot;&quot;</span><span class="hl std">)</span> <span class="hl opt">+</span>
  <span class="hl kwd">xlab</span><span class="hl std">(</span><span class="hl str">&quot;&quot;</span><span class="hl std">)</span> <span class="hl opt">+</span>
  <span class="hl kwd">labs</span><span class="hl std">(</span><span class="hl kwc">color</span> <span class="hl std">=</span> <span class="hl str">&quot;Altersgruppe&quot;</span><span class="hl std">)</span> <span class="hl opt">+</span>
  <span class="hl kwd">ylab</span><span class="hl std">(</span><span class="hl str">&quot;7-Tage Inzidenz&quot;</span><span class="hl std">)</span> <span class="hl opt">+</span>
  <span class="hl kwd">coord_cartesian</span><span class="hl std">(</span><span class="hl kwc">ylim</span> <span class="hl std">=</span> <span class="hl kwd">c</span><span class="hl std">(</span><span class="hl num">0.5</span><span class="hl std">,</span> <span class="hl kwd">max</span><span class="hl std">(dat_cases_age[date</span> <span class="hl opt">&gt;=</span> <span class="hl std">mindat, val_sum_group],</span> <span class="hl kwc">na.rm</span> <span class="hl std">= T)))</span>

<span class="hl std">p1</span>
</pre></div>
<div class="warning"><pre class="knitr r">## Warning in self$trans$transform(x): NaNs produced
</pre></div>
<div class="warning"><pre class="knitr r">## Warning: Transformation introduced infinite values in continuous y-axis
</pre></div>
</div><div class="rimage center"><img src="figure/b19-s06-3-ageStratIncidencePlot-211014-Rhtmlauto-report-1.png" title="plot of chunk auto-report" alt="plot of chunk auto-report" class="plot" /></div><div class="rcode">
<div class="source"><pre class="knitr r"><span class="hl std">p2</span> <span class="hl kwb">=</span> <span class="hl std">p1</span> <span class="hl opt">+</span> <span class="hl kwd">scale_y_continuous</span><span class="hl std">(</span><span class="hl kwc">breaks</span> <span class="hl std">=</span> <span class="hl kwd">pretty_breaks</span><span class="hl std">(</span><span class="hl num">12</span><span class="hl std">),</span><span class="hl kwc">sec.axis</span> <span class="hl std">=</span> <span class="hl kwd">dup_axis</span><span class="hl std">())</span> <span class="hl com">#+ theme(axis.title.y.right = element_blank())</span>
</pre></div>
<div class="message"><pre class="knitr r">## Scale for 'y' is already present. Adding another scale for 'y', which will replace the
## existing scale.
</pre></div>
<div class="source"><pre class="knitr r"><span class="hl std">p2</span>
</pre></div>
</div><div class="rimage center"><img src="figure/b19-s06-3-ageStratIncidencePlot-211014-Rhtmlauto-report-2.png" title="plot of chunk auto-report" alt="plot of chunk auto-report" class="plot" /></div><div class="rcode">
<div class="source"><pre class="knitr r"><span class="hl com"># Small check ----</span>

<span class="hl com"># calculate incidences without age stratification</span>
<span class="hl std">tmp</span> <span class="hl kwb">&lt;-</span> <span class="hl std">dat_cases_age[,</span> <span class="hl kwd">.</span><span class="hl std">(</span><span class="hl kwc">val</span> <span class="hl std">=</span> <span class="hl kwd">sum</span><span class="hl std">(value)),</span> <span class="hl kwd">.</span><span class="hl std">(date, location_name)]</span>
<span class="hl std">tmp[, val_rel</span> <span class="hl kwb">:=</span> <span class="hl std">(val</span> <span class="hl opt">/</span> <span class="hl num">83155031</span><span class="hl std">)</span><span class="hl opt">*</span> <span class="hl num">100000</span><span class="hl std">]</span>
<span class="hl std">tmp[,</span>  <span class="hl kwd">.</span><span class="hl std">(date,</span> <span class="hl kwd">frollsum</span><span class="hl std">(</span>
  <span class="hl kwc">n</span> <span class="hl std">=</span> <span class="hl num">7</span><span class="hl std">,</span>
  <span class="hl kwc">x</span> <span class="hl std">= val_rel,</span>
  <span class="hl kwc">align</span> <span class="hl std">=</span> <span class="hl str">&quot;right&quot;</span><span class="hl std">,</span>
  <span class="hl kwc">na.rm</span> <span class="hl std">= T)),</span> <span class="hl kwd">.</span><span class="hl std">(location_name)][location_name</span><span class="hl opt">==</span><span class="hl str">&quot;Germany&quot;</span> <span class="hl opt">&amp;</span> <span class="hl std">date</span> <span class="hl opt">&gt;=</span> <span class="hl str">&quot;2021-10-10&quot;</span><span class="hl std">]</span>
</pre></div>
<div class="output"><pre class="knitr r">##     location_name       date       V2
##  1:       Germany 2021-10-10 139.4287
##  2:       Germany 2021-10-11 139.4889
##  3:       Germany 2021-10-12 139.8580
##  4:       Germany 2021-10-13 140.7311
##  5:       Germany 2021-10-14 142.5169
##  6:       Germany 2021-10-15 145.1265
##  7:       Germany 2021-10-16 150.1292
##  8:       Germany 2021-10-17 152.7039
##  9:       Germany 2021-10-18 154.9744
## 10:       Germany 2021-10-19 159.2964
## 11:       Germany 2021-10-20 171.6072
## 12:       Germany 2021-10-21 180.5038
## 13:       Germany 2021-10-22 199.8725
## 14:       Germany 2021-10-23 210.0113
## 15:       Germany 2021-10-24 222.1694
## 16:       Germany 2021-10-25 228.2159
## 17:       Germany 2021-10-27 292.9372
## 18:       Germany 2021-10-28 319.4106
## 19:       Germany 2021-10-29 340.0552
## 20:       Germany 2021-10-30 344.7957
## 21:       Germany 2021-10-31 348.9651
## 22:       Germany 2021-11-01 339.1376
## 23:       Germany 2021-11-02 349.3367
## 24:       Germany 2021-11-03 317.3927
## 25:       Germany 2021-11-04 331.5001
## 26:       Germany 2021-11-05 361.4249
## 27:       Germany 2021-11-06 391.2499
## 28:       Germany 2021-11-07 407.2538
##     location_name       date       V2
</pre></div>
<div class="source"><pre class="knitr r"><span class="hl com"># Saving ----</span>

<span class="hl kwd">ggsave</span><span class="hl std">(</span><span class="hl kwc">plot</span> <span class="hl std">= p1,</span>
       <span class="hl kwc">filename</span> <span class="hl std">=</span> <span class="hl kwd">here</span><span class="hl std">(</span><span class="hl str">&quot;results/b19_s06_3_ageStratPlot.jpeg&quot;</span><span class="hl std">),</span>
       <span class="hl kwc">dpi</span> <span class="hl std">=</span> <span class="hl num">300</span><span class="hl std">,</span>
       <span class="hl kwc">device</span> <span class="hl std">=</span> <span class="hl str">&quot;jpeg&quot;</span><span class="hl std">,</span>
       <span class="hl kwc">units</span> <span class="hl std">=</span> <span class="hl str">&quot;in&quot;</span><span class="hl std">,</span>
       <span class="hl kwc">height</span> <span class="hl std">=</span> <span class="hl num">5</span><span class="hl std">,</span>
       <span class="hl kwc">width</span> <span class="hl std">=</span> <span class="hl num">9</span><span class="hl std">)</span>
</pre></div>
<div class="warning"><pre class="knitr r">## Warning in self$trans$transform(x): NaNs produced

## Warning in self$trans$transform(x): Transformation introduced infinite values in
## continuous y-axis
</pre></div>
<div class="source"><pre class="knitr r"><span class="hl com"># # </span>
<span class="hl com"># # # save data</span>
<span class="hl com"># fwrite(x = dat_cases_age,</span>
<span class="hl com">#        file = here(&quot;results/b19_s06_3_ageStratDat_211014.tsv&quot;),</span>
<span class="hl com">#        sep = &quot;\t&quot;)</span>

<span class="hl com"># Session Info ----</span>

<span class="hl kwd">sessionInfo</span><span class="hl std">()</span>
</pre></div>
<div class="output"><pre class="knitr r">## R version 4.1.1 (2021-08-10)
## Platform: x86_64-w64-mingw32/x64 (64-bit)
## Running under: Windows 10 x64 (build 19043)
## 
## Matrix products: default
## 
## locale:
## [1] LC_COLLATE=German_Germany.1252  LC_CTYPE=German_Germany.1252   
## [3] LC_MONETARY=German_Germany.1252 LC_NUMERIC=C                   
## [5] LC_TIME=German_Germany.1252    
## 
## attached base packages:
## [1] stats     graphics  grDevices utils     datasets  methods   base     
## 
## other attached packages:
##  [1] toolboxH_0.2.16    eulerr_6.1.1       testthat_3.1.0     stringr_1.4.0     
##  [5] readxl_1.3.1       RColorBrewer_1.1-2 png_0.1-7          fdrtool_1.2.16    
##  [9] R.utils_2.11.0     R.oo_1.24.0        R.methodsS3_1.8.1  lubridate_1.8.0   
## [13] here_1.0.1         scales_1.1.1       magrittr_2.0.1     ggthemes_4.2.4    
## [17] ggplot2_3.3.5      data.table_1.14.2 
## 
## loaded via a namespace (and not attached):
##  [1] Rcpp_1.0.7       cellranger_1.1.0 compiler_4.1.1   pillar_1.6.3     highr_0.9       
##  [6] tools_4.1.1      digest_0.6.28    evaluate_0.14    lifecycle_1.0.1  tibble_3.1.5    
## [11] gtable_0.3.0     pkgconfig_2.0.3  rlang_0.4.11     curl_4.3.2       xfun_0.26       
## [16] fastmap_1.1.0    withr_2.4.2      dplyr_1.0.7      knitr_1.36       generics_0.1.0  
## [21] vctrs_0.3.8      rprojroot_2.0.2  tidyselect_1.1.1 grid_4.1.1       glue_1.4.2      
## [26] R6_2.5.1         fansi_0.5.0      rmarkdown_2.11   farver_2.1.0     purrr_0.3.4     
## [31] htmltools_0.5.2  ellipsis_0.3.2   colorspace_2.0-2 labeling_0.4.2   utf8_1.2.2      
## [36] stringi_1.7.5    munsell_0.5.0    crayon_1.4.1
</pre></div>
</div></div>

  <p>The R session information (including the OS info, R version and all
    packages used):</p>

<div class="chunk" id="session-info"><div class="rcode"><div class="source"><pre class="knitr r">    <span class="hl kwd">sessionInfo</span><span class="hl std">()</span>
</pre></div>
<div class="output"><pre class="knitr r">## R version 4.1.1 (2021-08-10)
## Platform: x86_64-w64-mingw32/x64 (64-bit)
## Running under: Windows 10 x64 (build 19043)
## 
## Matrix products: default
## 
## locale:
## [1] LC_COLLATE=German_Germany.1252  LC_CTYPE=German_Germany.1252   
## [3] LC_MONETARY=German_Germany.1252 LC_NUMERIC=C                   
## [5] LC_TIME=German_Germany.1252    
## 
## attached base packages:
## [1] stats     graphics  grDevices utils     datasets  methods   base     
## 
## other attached packages:
##  [1] toolboxH_0.2.16    eulerr_6.1.1       testthat_3.1.0     stringr_1.4.0     
##  [5] readxl_1.3.1       RColorBrewer_1.1-2 png_0.1-7          fdrtool_1.2.16    
##  [9] R.utils_2.11.0     R.oo_1.24.0        R.methodsS3_1.8.1  lubridate_1.8.0   
## [13] here_1.0.1         scales_1.1.1       magrittr_2.0.1     ggthemes_4.2.4    
## [17] ggplot2_3.3.5      data.table_1.14.2 
## 
## loaded via a namespace (and not attached):
##  [1] Rcpp_1.0.7       cellranger_1.1.0 compiler_4.1.1   pillar_1.6.3     highr_0.9       
##  [6] tools_4.1.1      digest_0.6.28    evaluate_0.14    lifecycle_1.0.1  tibble_3.1.5    
## [11] gtable_0.3.0     pkgconfig_2.0.3  rlang_0.4.11     curl_4.3.2       xfun_0.26       
## [16] fastmap_1.1.0    withr_2.4.2      dplyr_1.0.7      knitr_1.36       generics_0.1.0  
## [21] vctrs_0.3.8      rprojroot_2.0.2  tidyselect_1.1.1 grid_4.1.1       glue_1.4.2      
## [26] R6_2.5.1         fansi_0.5.0      rmarkdown_2.11   farver_2.1.0     purrr_0.3.4     
## [31] htmltools_0.5.2  ellipsis_0.3.2   colorspace_2.0-2 labeling_0.4.2   utf8_1.2.2      
## [36] stringi_1.7.5    munsell_0.5.0    crayon_1.4.1
</pre></div>
<div class="source"><pre class="knitr r">    <span class="hl kwd">Sys.time</span><span class="hl std">()</span>
</pre></div>
<div class="output"><pre class="knitr r">## [1] &quot;2021-11-08 11:56:06 CET&quot;
</pre></div>
</div></div>


</body>
</html>
